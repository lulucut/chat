"use strict";var img=new Image,Chat=function(){function t(){this.socket=null,this.init()}function e(t){v.text(t.size),t.flag?w('<div class="user-in">\n\t\t\t\t欢迎\n\t\t\t\t<img class="user-img '+S+'" alt="'+(t.nickname===y?N:t.nickname)+'" src="images/face.jpeg" />\n\t\t\t\t<strong class="user-name">'+t.nickname+"</strong> \n\t\t\t\t加入群聊！\n\t\t\t</div>"):s("system","用户 "+t.nickname+" 已经离开群聊")}function n(t,e,n){n=n?"me-":"";var s='<div class="'+n+'chat-info">\n\t\t\t<img class="user-normal-img '+S+'" alt="'+t+'" src="images/face.jpeg" />\n\t\t\t<span class="time">\n\t\t\t\t<strong class="user-name">'+t+"</strong> \n\t\t\t\t"+f()+'\n\t\t\t</span>\n\t\t\t<span class="'+n+'message">\n\t\t\t\t'+e+"\n\t\t\t</span>\n\t\t</div>";w(s)}function s(t,e){n(t,e,!1)}function i(t){n(N,t,!0)}function a(){var t=L(".active"),e=L(".show");p=L(".info"),v=L("#peopel"),h=L("#msg-area").get(0),k=L("#nickname"),C=L("#users"),j.group={user:t,ele:e},e.show(),Object.defineProperty(H,"ele",{get:function(){return t.data("id")},set:function(n){var s=n.data("id");if(t.removeClass("active"),n.addClass("active"),e.removeClass("show"),j[s])e=j[s].ele,e.addClass("show");else{var i=o(s);h.appendChild(i.get(0)),e=i,j[s]={user:n,ele:e}}t=n}}),k.get(0).focus(),l(),r(),w=m(j.group.ele),this.initSend()}function o(t){return L('<div class="msg show" data-id='+t+'>\n\t\t\t\t<p class="attention">与'+t+"私聊中</p>\n\t\t\t</div>")}function c(t){return L('<li class="user" data-id="'+t+'">\n\t\t\t\t<img class="user-img-style", src="images/face.jpeg" />\n\t\t\t\t'+t+'\n\t\t\t\t<span class="count">0</span>\n\t\t\t\t<span class="close">╳</span>\n\t\t\t</li>')}function r(){L("#group").click(function(t){var e=t.target;if(~e.className.indexOf(S)&&"我"!==e.alt){var n=e.alt;if(!j[n]){var s=c(n);C.get(0).appendChild(s.get(0)),H.ele=s}H.ele=j[n].user}})}function l(){C.click(function(t){var e=t.target;if("close"===e.className)return void u(e);for(;"LI"!==e.tagName;)e=e.parentNode;H.ele=L(e)})}function u(t){t=t.parentNode,j.del(t.getAttribute("data-id"))}function g(t){return x.innerHTML=t,x.childNodes[0]}function m(t){var e=t.get(0);return function(t){e.appendChild(g(t)),e.scrollTop=e.scrollHeight}}function f(){var t=new Date;return t.getFullYear()+"/"+t.getMonth()+"/"+t.getDate()+"  "+t.getHours()+":"+d(t.getMinutes())+":"+d(t.getSeconds())}function d(t){return String(t).length<2?"0"+t:t}var p,v,h,k,w,C,y,j={del:function(t){H.ele===t&&(H.ele=j.group.user),C.get(0).removeChild(j[t].user.get(0)),h.removeChild(j[t].ele.get(0)),delete j[t]}},N="我",S="to-private",b=t.prototype,x=document.createElement("div"),H={},M=!1;return b.init=function(){var t=this;this.socket=io.connect(),this.socket.on("connect",function(){L(".loading").hide(),L(".enter-name").show(),a.call(t),t.login(),t.system(),t.newmsg()})},b.login=function(){var t=this;L("#send-name").click(function(){y=k.val(),y.trim()?t.socket.emit("login",y):p.text("your nickname can't be blank or just spaces")}),this.socket.on("loginSuccess",function(){M=!0,L("#mask").hide()}),this.socket.on("repeat",function(){p.text("your nickname is token, please use another")})},b.system=function(){this.socket.on("system",function(t){M&&e(t)})},b.newmsg=function(){this.socket.on("newmsg",function(t,e){s(t,e)})},b.initSend=function(){var t=this;L("#send").click(function(){var e=L("#msg-input"),n=e.val();n.trim()&&(e.val(""),i(n),t.socket.emit("postmsg",n)),e.get(0).focus()})},t}();L(window).load(function(){new Chat,img.src="images/face.jpeg",img.onerror=function(){this.src="images/logo.png"}});