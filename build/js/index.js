"use strict";var img=new Image,Chat=function(){function t(){this.socket=null,this.init()}function e(t){w.text(t.size),t.flag?b('<div class="user-in">\n\t\t\t\t欢迎\n\t\t\t\t<img class="user-img '+D+'" alt="'+(t.nickname===N?H:t.nickname)+'" src="images/face.jpeg" />\n\t\t\t\t<strong class="user-name">'+t.nickname+"</strong>\n\t\t\t\t加入群聊！\n\t\t\t</div>"):i("system","用户 "+t.nickname+" 已经离开群聊")}function n(t,e,n,i){n=n?"me-":"",b('<div class="'+n+'chat-info">\n\t\t\t<img class="user-normal-img '+D+'" alt="'+t+'" src="images/face.jpeg" />\n\t\t\t<span class="time">\n\t\t\t\t<strong class="user-name">'+t+"</strong>\n\t\t\t\t"+p()+'\n\t\t\t</span>\n\t\t\t<span class="'+n+'message">\n\t\t\t\t'+e+"\n\t\t\t</span>\n\t\t</div>",i)}function i(t,e,i){n(t,e,!1,i)}function s(t,e){n(H,t,!0,e)}function a(t){return'<img src="'+t+'" class="msg-img" />'}function c(){var t=L(".active");S=L(".show"),k=L(".info"),w=L("#peopel"),C=L("#msg-area").get(0),y=L("#nickname"),j=L("#users"),x[I]={user:t,ele:S},o(I),S.show(),Object.defineProperty(A,"ele",{get:function(){return t.data("id")},set:function(e){var n=e.data("id");if(t.removeClass("active"),e.addClass("active"),S.removeClass("show"),x[n])S=x[n].ele,S.addClass("show"),x[n].num=0;else{var i=r(n);C.appendChild(i.get(0)),S=i,x[n]={user:e,ele:S},o(n)}S.get(0).scrollTop=S.get(0).scrollHeight,t=e}}),y.get(0).focus(),g(),u(),b=d(x[I].ele),this.initSend(),this.initImg()}function o(t){var e=0,n=x[t].user.find(".count");Object.defineProperty(x[t],"num",{get:function(){return e},set:function(i){A.ele!==t&&(0===i?n.css({visibility:"hidden"}):1===i&&n.css({visibility:"visible"}),e=i,n.text(e))}})}function r(t,e){var n=L('<div class="msg'+(e?"":" show")+'" data-id='+t+'>\n\t\t\t\t<p class="attention">与'+t+"私聊中</p>\n\t\t\t</div>");return C.appendChild(n.get(0)),n}function l(t){return L('<li class="user" data-id="'+t+'">\n\t\t\t\t<img class="user-img-style", src="images/face.jpeg" />\n\t\t\t\t'+t+'\n\t\t\t\t<span class="count">0</span>\n\t\t\t\t<span class="close">╳</span>\n\t\t\t</li>')}function u(){L("#group").click(function(t){var e=t.target;if(~e.className.indexOf(D)&&"我"!==e.alt){var n=e.alt;if(!x[n]){var i=l(n);j.get(0).appendChild(i.get(0)),A.ele=i}A.ele=x[n].user}})}function g(){j.click(function(t){var e=t.target;if("close"===e.className)return void f(e);for(;"LI"!==e.tagName;)e=e.parentNode;A.ele=L(e)})}function f(t){t=t.parentNode,x.del(t.getAttribute("data-id"))}function m(t){return T.innerHTML=t,T.childNodes[0]}function d(t){var e=t.get(0);return function(t,n){var i=n||e;i.appendChild(m(t)),i.scrollTop=i.scrollHeight}}function p(){var t=new Date;return t.getFullYear()+"/"+(t.getMonth()+1)+"/"+t.getDate()+"  "+t.getHours()+":"+h(t.getMinutes())+":"+h(t.getSeconds())}function h(t){return String(t).length<2?"0"+t:t}function v(t){return String(t).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}var k,w,C,y,b,j,N,S,x={del:function(t){A.ele===t&&(A.ele=x.group.user),j.get(0).removeChild(x[t].user.get(0)),C.removeChild(x[t].ele.get(0)),delete x[t]}},H="我",I="group",D="to-private",M=/^image\//,O=t.prototype,T=document.createElement("div"),A={},F=!1;return O.init=function(){var t=this;this.socket=io.connect(),this.socket.on("connect",function(){L(".loading").hide(),L(".enter-name").show(),c.call(t),t.login(),t.register()})},O.register=function(){this.socket.on("loginSuccess",function(){F=!0,L("#mask").hide()}),this.socket.on("repeat",function(){k.text("your nickname is token, please use another")}),this.socket.on("pcmsg",function(t){var e=t.source,n=null;x[e]||(x[e]={user:l(e),ele:r(e,!0)},o(e),j.get(0).appendChild(x[e].user.get(0))),x[e].num+=1,n=x[e].ele,i(e,t.msg,n.get(0))}),this.socket.on("nouser",function(t){b('<p class="attention">'+t+"</p>",S.get(0))}),this.socket.on("newmsg",function(t,e){x[I].num+=1,i(t,e)}),this.socket.on("system",function(t){F&&e(t)})},O.login=function(){var t=this;L("#send-name").click(function(){N=v(y.val()),N.trim()?t.socket.emit("login",N):k.text("your nickname can't be blank or just spaces")})},O.initSend=function(){var t=this;L("#send").click(function(){var e=L("#msg-input"),n=e.val();if(n.trim()){var i=A.ele;e.val(""),t.message(i,v(n))}e.get(0).focus()})},O.message=function(t,e){s(e,S.get(0)),t===I?this.socket.emit("postmsg",e):this.socket.emit("pc",{target:t,msg:e})},O.initImg=function(){var t=L("#file"),e=this;L("#image").click(function(){t.get(0).click()}),t.change(function(){var t=this;if(0!==this.files.length){var n=this.files[0];if(M.test(n.type)){var i=new FileReader;i.onload=function(n){t.value="",e.message(A.ele,a(n.target.result))},i.readAsDataURL(n)}}})},t}();L(window).load(function(){new Chat,img.src="images/face.jpeg",img.onerror=function(){this.src="images/logo.png"}});