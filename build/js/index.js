"use strict";var img=new Image,Chat=function(){function t(){this.socket=null,this.init()}function e(t){h.text(t.size),t.flag?w('<div class="user-in">\n\t\t\t\t欢迎\n\t\t\t\t<img class="user-img '+H+'" alt="'+(t.nickname===b?x:t.nickname)+'" src="images/face.jpeg" />\n\t\t\t\t<strong class="user-name">'+t.nickname+"</strong> \n\t\t\t\t加入群聊！\n\t\t\t</div>"):s("system","用户 "+t.nickname+" 已经离开群聊")}function n(t,e,n,s){n=n?"me-":"";var i='<div class="'+n+'chat-info">\n\t\t\t<img class="user-normal-img '+H+'" alt="'+t+'" src="images/face.jpeg" />\n\t\t\t<span class="time">\n\t\t\t\t<strong class="user-name">'+t+"</strong> \n\t\t\t\t"+d()+'\n\t\t\t</span>\n\t\t\t<span class="'+n+'message">\n\t\t\t\t'+e+"\n\t\t\t</span>\n\t\t</div>";w(i,s)}function s(t,e,s){n(t,e,!1,s)}function i(t,e){n(x,t,!0,e)}function a(){var t=L(".active");j=L(".show"),v=L(".info"),h=L("#peopel"),k=L("#msg-area").get(0),C=L("#nickname"),y=L("#users"),N[S]={user:t,ele:j},o(S),j.show(),Object.defineProperty(T,"ele",{get:function(){return t.data("id")},set:function(e){var n=e.data("id");if(t.removeClass("active"),e.addClass("active"),j.removeClass("show"),N[n])j=N[n].ele,j.addClass("show"),N[n].num=0;else{var s=c(n);k.appendChild(s.get(0)),j=s,N[n]={user:e,ele:j},o(n)}j.get(0).scrollTop=j.get(0).scrollHeight,t=e}}),C.get(0).focus(),u(),l(),w=m(N[S].ele),this.initSend()}function o(t){var e=0,n=N[t].user.find(".count");Object.defineProperty(N[t],"num",{get:function(){return e},set:function(s){T.ele!==t&&(0===s?n.css({visibility:"hidden"}):1===s&&n.css({visibility:"visible"}),e=s,n.text(e))}})}function c(t,e){var n=L('<div class="msg'+(e?"":" show")+'" data-id='+t+'>\n\t\t\t\t<p class="attention">与'+t+"私聊中</p>\n\t\t\t</div>");return k.appendChild(n.get(0)),n}function r(t){return L('<li class="user" data-id="'+t+'">\n\t\t\t\t<img class="user-img-style", src="images/face.jpeg" />\n\t\t\t\t'+t+'\n\t\t\t\t<span class="count">0</span>\n\t\t\t\t<span class="close">╳</span>\n\t\t\t</li>')}function l(){L("#group").click(function(t){var e=t.target;if(~e.className.indexOf(H)&&"我"!==e.alt){var n=e.alt;if(!N[n]){var s=r(n);y.get(0).appendChild(s.get(0)),T.ele=s}T.ele=N[n].user}})}function u(){y.click(function(t){var e=t.target;if("close"===e.className)return void g(e);for(;"LI"!==e.tagName;)e=e.parentNode;T.ele=L(e)})}function g(t){t=t.parentNode,N.del(t.getAttribute("data-id"))}function f(t){return O.innerHTML=t,O.childNodes[0]}function m(t){var e=t.get(0);return function(t,n){var s=n||e;s.appendChild(f(t)),s.scrollTop=s.scrollHeight}}function d(){var t=new Date;return t.getFullYear()+"/"+t.getMonth()+"/"+t.getDate()+"  "+t.getHours()+":"+p(t.getMinutes())+":"+p(t.getSeconds())}function p(t){return String(t).length<2?"0"+t:t}var v,h,k,C,w,y,b,j,N={del:function(t){T.ele===t&&(T.ele=N.group.user),y.get(0).removeChild(N[t].user.get(0)),k.removeChild(N[t].ele.get(0)),delete N[t]}},x="我",S="group",H="to-private",M=t.prototype,O=document.createElement("div"),T={},D=!1;return M.init=function(){var t=this;this.socket=io.connect(),this.socket.on("connect",function(){L(".loading").hide(),L(".enter-name").show(),a.call(t),t.login(),t.register()})},M.register=function(){this.socket.on("loginSuccess",function(){D=!0,L("#mask").hide()}),this.socket.on("repeat",function(){v.text("your nickname is token, please use another")}),this.socket.on("pcmsg",function(t){var e=t.source,n=null;N[e]||(N[e]={user:r(e),ele:c(e,!0)},o(e),y.get(0).appendChild(N[e].user.get(0))),N[e].num+=1,n=N[e].ele,s(e,t.msg,n.get(0))}),this.socket.on("nouser",function(){w('<p class="attention">该用户已经下线</p>',j.get(0))}),this.socket.on("newmsg",function(t,e){N[S].num+=1,s(t,e)}),this.socket.on("system",function(t){D&&e(t)})},M.login=function(){var t=this;L("#send-name").click(function(){b=C.val(),b.trim()?t.socket.emit("login",b):v.text("your nickname can't be blank or just spaces")})},M.initSend=function(){var t=this;L("#send").click(function(){var e=L("#msg-input"),n=e.val();if(n.trim()){var s=T.ele;e.val(""),i(n,j.get(0)),s===S?t.socket.emit("postmsg",n):t.socket.emit("pc",{target:s,msg:n})}e.get(0).focus()})},t}();L(window).load(function(){new Chat,img.src="images/face.jpeg",img.onerror=function(){this.src="images/logo.png"}});