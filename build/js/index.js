"use strict";var img=new Image,Chat=function(){function t(){this.socket=null,this.init()}function e(t){v.text(t.size),t.flag?w('<div class="user-in">\n\t\t\t\t欢迎\n\t\t\t\t<img class="user-img '+x+'" alt="'+(t.nickname===y?S:t.nickname)+'" src="images/face.jpeg" />\n\t\t\t\t<strong class="user-name">'+t.nickname+"</strong> \n\t\t\t\t加入群聊！\n\t\t\t</div>"):s("system","用户 "+t.nickname+" 已经离开群聊")}function n(t,e,n,s){n=n?"me-":"";var i='<div class="'+n+'chat-info">\n\t\t\t<img class="user-normal-img '+x+'" alt="'+t+'" src="images/face.jpeg" />\n\t\t\t<span class="time">\n\t\t\t\t<strong class="user-name">'+t+"</strong> \n\t\t\t\t"+f()+'\n\t\t\t</span>\n\t\t\t<span class="'+n+'message">\n\t\t\t\t'+e+"\n\t\t\t</span>\n\t\t</div>";w(i,s)}function s(t,e,s){n(t,e,!1,s)}function i(t,e){n(S,t,!0,e)}function a(){var t=L(".active");j=L(".show"),p=L(".info"),v=L("#peopel"),h=L("#msg-area").get(0),k=L("#nickname"),C=L("#users"),N[b]={user:t,ele:j},j.show(),Object.defineProperty(D,"ele",{get:function(){return t.data("id")},set:function(e){var n=e.data("id");if(t.removeClass("active"),e.addClass("active"),j.removeClass("show"),N[n])j=N[n].ele,j.addClass("show");else{var s=o(n);h.appendChild(s.get(0)),j=s,N[n]={user:e,ele:j}}t=e}}),k.get(0).focus(),l(),r(),w=m(N[b].ele),this.initSend()}function o(t){return L('<div class="msg show" data-id='+t+'>\n\t\t\t\t<p class="attention">与'+t+"私聊中</p>\n\t\t\t</div>")}function c(t){return L('<li class="user" data-id="'+t+'">\n\t\t\t\t<img class="user-img-style", src="images/face.jpeg" />\n\t\t\t\t'+t+'\n\t\t\t\t<span class="count">0</span>\n\t\t\t\t<span class="close">╳</span>\n\t\t\t</li>')}function r(){L("#group").click(function(t){var e=t.target;if(~e.className.indexOf(x)&&"我"!==e.alt){var n=e.alt;if(!N[n]){var s=c(n);C.get(0).appendChild(s.get(0)),D.ele=s}D.ele=N[n].user}})}function l(){C.click(function(t){var e=t.target;if("close"===e.className)return void u(e);for(;"LI"!==e.tagName;)e=e.parentNode;D.ele=L(e)})}function u(t){t=t.parentNode,N.del(t.getAttribute("data-id"))}function g(t){return M.innerHTML=t,M.childNodes[0]}function m(t){var e=t.get(0);return function(t,n){var s=n||e;s.appendChild(g(t)),s.scrollTop=s.scrollHeight}}function f(){var t=new Date;return t.getFullYear()+"/"+t.getMonth()+"/"+t.getDate()+"  "+t.getHours()+":"+d(t.getMinutes())+":"+d(t.getSeconds())}function d(t){return String(t).length<2?"0"+t:t}var p,v,h,k,w,C,y,j,N={del:function(t){D.ele===t&&(D.ele=N.group.user),C.get(0).removeChild(N[t].user.get(0)),h.removeChild(N[t].ele.get(0)),delete N[t]}},S="我",b="group",x="to-private",H=t.prototype,M=document.createElement("div"),D={},I=!1;return H.init=function(){var t=this;this.socket=io.connect(),this.socket.on("connect",function(){L(".loading").hide(),L(".enter-name").show(),a.call(t),t.login(),t.system(),t.newmsg()})},H.login=function(){var t=this;L("#send-name").click(function(){y=k.val(),y.trim()?t.socket.emit("login",y):p.text("your nickname can't be blank or just spaces")}),this.socket.on("loginSuccess",function(){I=!0,L("#mask").hide()}),this.socket.on("repeat",function(){p.text("your nickname is token, please use another")}),this.socket.on("pcmsg",function(t){var e=t.source;if(N[e])D.ele=N[e].user;else{var n=c(e);C.get(0).appendChild(n.get(0)),D.ele=n}s(e,t.msg,j.get(0))})},H.system=function(){this.socket.on("system",function(t){I&&e(t)})},H.newmsg=function(){this.socket.on("newmsg",function(t,e){s(t,e)})},H.initSend=function(){var t=this;L("#send").click(function(){var e=L("#msg-input"),n=e.val();if(n.trim()){var s=D.ele;e.val(""),i(n,j.get(0)),s===b?t.socket.emit("postmsg",n):t.socket.emit("pc",{target:s,msg:n})}e.get(0).focus()})},t}();L(window).load(function(){new Chat,img.src="images/face.jpeg",img.onerror=function(){this.src="images/logo.png"}});